sudo: false

language:
  node_js

node_js:
  - '8'

cache:
  yarn: true
  directories:
    - frontend/node_modules
    - backend/node_modules

before_install:
  - yarn global add now
  - echo "${DOTENV_STAGING}" > .env

script:
  npm run ci

jobs:
  include:
    - stage: build
      script:
        - cd backend
        - yarn --frozen-lockfile
        - yarn build
    - stage: test
      script:
        - cd backend
        - yarn test
    - stage: test
      script:
        - cd frontend
        - yarn --frozen-lockfile
        - yarn test
    - stage: deploy
      script:
        - cd backend
        - yarn prisma login --key="${PRISMA_CLOUD_SESSION_KEY}"
        - yarn prisma deploy
        - now --dotenv -t ${NOW_TOKEN} -T volst
        - now alias -t ${NOW_TOKEN} -T volst

stages:
  - build
  - test
  - name: deploy
    if: branch = master

after_success:
